---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout
  title="Complete Registration"
  description="Complete your Flowmaster Scout profile"
  showNav={false}
>
  <div class="complete-page">
    <div class="complete-container">
      <div class="logo-container">
        <a href="/" class="logo-link">
          <span class="logo-text">Flowmaster</span>
        </a>
      </div>

      <!-- Loading / Verifying Auth -->
      <div id="loading-state" class="state-container">
        <div class="spinner"></div>
        <p class="loading-text">Verifying your session...</p>
      </div>

      <!-- Profile Form -->
      <div id="form-state" class="state-container" style="display: none;">
        <h1 class="headline">Almost There! ðŸŽ‰</h1>
        <p class="subheadline">Complete your Scout profile</p>

        <div class="form-box">
          <div class="field">
            <label for="username">Username *</label>
            <input
              type="text"
              id="username"
              class="field-input"
              placeholder="coolscout42"
              maxlength="12"
              pattern="[a-z0-9]{4,12}"
            />
            <span class="field-hint">4-12 characters, lowercase letters and numbers only</span>
            <span class="field-error" id="username-error"></span>
          </div>

          <div class="field">
            <label for="display-name">Your Name *</label>
            <input
              type="text"
              id="display-name"
              class="field-input"
              placeholder="John Smith"
            />
            <span class="field-hint">So we know who you are</span>
          </div>

          <div class="field">
            <label for="discord">Discord Handle *</label>
            <input
              type="text"
              id="discord"
              class="field-input"
              placeholder="coolscout"
            />
            <span class="field-hint">Required for Scout communications</span>
          </div>

          <button id="submit-btn" class="btn-submit" disabled>
            Complete Registration
          </button>

          <p id="form-error" class="form-error" style="display: none;"></p>
          <p id="form-submitting" class="form-submitting" style="display: none;">Creating your Scout account...</p>
        </div>
      </div>

      <!-- Auth Error -->
      <div id="error-state" class="state-container" style="display: none;">
        <div class="error-emoji">ðŸ˜•</div>
        <h1 class="headline">Session Expired</h1>
        <p class="error-message">
          Your magic link has expired or is invalid. Please request a new one.
        </p>
        <a href="https://www.flowmaster.live" class="btn-primary-link">Visit Flowmaster</a>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .complete-page {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
  }

  .complete-container {
    max-width: 520px;
    width: 100%;
    text-align: center;
  }

  .logo-container {
    margin-bottom: 2.5rem;
    animation: fade-in-up 0.6s ease-out;
  }

  .logo-link { text-decoration: none; }

  .logo-text {
    font-family: var(--font-heading);
    font-size: 2rem;
    font-weight: 700;
    color: #f2f2f2;
  }

  .state-container {
    animation: fade-in-up 0.6s ease-out 0.2s backwards;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-bg-tertiary);
    border-top-color: #facf64;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    color: var(--color-gray-400);
    font-size: 1rem;
  }

  .headline {
    font-size: 2.25rem;
    margin-bottom: 0.75rem;
    color: #f2f2f2;
  }

  .subheadline {
    font-size: 1.125rem;
    color: var(--color-gray-300);
    margin-bottom: 2rem;
  }

  .form-box {
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-bg-tertiary);
    border-radius: 0.75rem;
    padding: 1.5rem;
    text-align: left;
  }

  .field {
    margin-bottom: 1.25rem;
  }

  .field label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: #f2f2f2;
    margin-bottom: 0.5rem;
  }

  .field-input {
    width: 100%;
    padding: 0.75rem 1rem;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-gray-700);
    border-radius: 0.5rem;
    color: #f2f2f2;
    font-size: 1rem;
    font-family: var(--font-body);
    outline: none;
    transition: border-color 0.2s;
    box-sizing: border-box;
  }

  .field-input:focus {
    border-color: #facf64;
  }

  .field-input::placeholder {
    color: var(--color-gray-500);
  }

  .field-hint {
    display: block;
    font-size: 0.8rem;
    color: var(--color-gray-500);
    margin-top: 0.35rem;
  }

  .field-error {
    display: block;
    font-size: 0.8rem;
    color: var(--color-brand-red);
    margin-top: 0.35rem;
    min-height: 1.1em;
  }

  .btn-submit {
    display: block;
    width: 100%;
    padding: 0.85rem;
    margin-top: 0.5rem;
    background: #facf64;
    color: #101010;
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 1rem;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-submit:hover:not(:disabled) {
    background: #ffe08a;
    box-shadow: 0 10px 20px -5px rgba(250, 207, 100, 0.2);
  }

  .btn-submit:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .form-error {
    margin-top: 0.75rem;
    color: var(--color-brand-red);
    font-size: 0.85rem;
  }

  .form-submitting {
    margin-top: 0.75rem;
    color: #facf64;
    font-size: 0.85rem;
  }

  .error-emoji {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .error-message {
    font-size: 1.125rem;
    color: var(--color-gray-300);
    margin-bottom: 2rem;
    line-height: 1.6;
  }

  .btn-primary-link {
    display: inline-flex;
    align-items: center;
    background-color: var(--color-brand-red);
    color: #f2f2f2;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    text-decoration: none;
    transition: all 0.2s;
  }

  .btn-primary-link:hover {
    background-color: var(--color-brand-red-bright);
  }

  @keyframes fade-in-up {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<script>
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  const SUPABASE_URL = 'https://zkmfjmzoqjcylvhxbwii.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InprbWZqbXpvcWpjeWx2aHhid2lpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0OTQ0ODYsImV4cCI6MjA1MzA3MDQ4Nn0.ICVG1fXBbSKX6djfJfGhzVETm_LNqA-iSHIKqMjbxbs';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function init() {
    // Parse Supabase auth callback from hash fragment
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = hashParams.get('access_token');
    const type = hashParams.get('type');

    if (type === 'magiclink' && accessToken) {
      // Supabase client picks up the session automatically
      const { data: { session }, error } = await supabase.auth.getSession();

      if (session && !error) {
        showForm(session);
        return;
      }
    }

    // Also try existing session (page refresh after auth)
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      showForm(session);
      return;
    }

    // No valid session
    showError();
  }

  function showForm(session: any) {
    document.getElementById('loading-state')!.style.display = 'none';
    document.getElementById('error-state')!.style.display = 'none';
    document.getElementById('form-state')!.style.display = 'block';
    setupProfileForm(session);
  }

  function showError() {
    document.getElementById('loading-state')!.style.display = 'none';
    document.getElementById('form-state')!.style.display = 'none';
    document.getElementById('error-state')!.style.display = 'block';
  }

  function setupProfileForm(session: any) {
    const usernameInput = document.getElementById('username') as HTMLInputElement;
    const displayNameInput = document.getElementById('display-name') as HTMLInputElement;
    const discordInput = document.getElementById('discord') as HTMLInputElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const usernameError = document.getElementById('username-error')!;
    const formError = document.getElementById('form-error')!;
    const formSubmitting = document.getElementById('form-submitting')!;

    const usernamePattern = /^[a-z0-9]{4,12}$/;

    function updateButtonState() {
      const usernameValid = usernamePattern.test(usernameInput.value);
      const nameValid = displayNameInput.value.trim().length > 0;
      const discordValid = discordInput.value.trim().length > 0;
      submitBtn.disabled = !(usernameValid && nameValid && discordValid);
    }

    // Auto-lowercase username
    usernameInput.addEventListener('input', () => {
      usernameInput.value = usernameInput.value.toLowerCase().replace(/[^a-z0-9]/g, '');
      if (usernameInput.value && !usernamePattern.test(usernameInput.value)) {
        usernameError.textContent = '4-12 characters, lowercase letters and numbers only';
      } else {
        usernameError.textContent = '';
      }
      updateButtonState();
    });

    displayNameInput.addEventListener('input', updateButtonState);
    discordInput.addEventListener('input', updateButtonState);

    submitBtn.addEventListener('click', async () => {
      formError.style.display = 'none';
      formSubmitting.style.display = 'block';
      submitBtn.disabled = true;

      // Get the invite code from sessionStorage or URL referrer
      const inviteCode = sessionStorage.getItem('scout_invite_code') || '';

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/complete-scout-registration`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${session.access_token}`,
          },
          body: JSON.stringify({
            username: usernameInput.value,
            display_name: displayNameInput.value.trim(),
            discord_handle: discordInput.value.trim(),
            invite_code: inviteCode,
          })
        });

        const data = await response.json();

        if (data.success) {
          // Store scout key for welcome page
          sessionStorage.setItem('scout_key', data.scout_key);
          window.location.href = '/scout/welcome/';
        } else {
          if (data.reason === 'username_taken') {
            usernameError.textContent = 'This username is already taken. Try another.';
          } else {
            formError.textContent = data.message || 'Registration failed. Please try again.';
            formError.style.display = 'block';
          }
          formSubmitting.style.display = 'none';
          submitBtn.disabled = false;
        }
      } catch (err) {
        formError.textContent = 'Network error. Please check your connection and try again.';
        formError.style.display = 'block';
        formSubmitting.style.display = 'none';
        submitBtn.disabled = false;
      }
    });
  }

  init();
</script>
