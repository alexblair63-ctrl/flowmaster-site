---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ScoutConductModal from '../../components/ScoutConductModal.astro';
---

<BaseLayout
  title="Scout Program"
  description="Join the Flowmaster Scout Program - become a brand ambassador"
  showNav={false}
>
  <div class="scout-page">
    <div class="scout-container">
      <!-- Logo -->
      <div class="logo-container">
        <a href="/" class="logo-link">
          <span class="logo-text">Flowmaster</span>
        </a>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="state-container">
        <div class="spinner"></div>
        <p class="loading-text">Validating your invite...</p>
      </div>

      <!-- Main Content (hidden until validated) -->
      <div id="main-state" class="state-container" style="display: none;">
        <div class="selected-badge">YOU'VE BEEN SELECTED</div>
        <h1 class="headline">Join the Flowmaster Scout Program</h1>

        <div class="pitch-box">
          <p class="pitch-intro">
            You've been personally invited to represent Flowmaster as a Scout.
            This is both an opportunity and a responsibility.
          </p>

          <div class="pitch-section">
            <h3 class="pitch-heading">As a Scout, you'll:</h3>
            <ul class="pitch-list">
              <li>Generate exclusive beta invite links</li>
              <li>Earn passive income when referrals go Pro</li>
              <li>Get Flowmaster FREE for 3 months (then 50% off Pro)</li>
              <li>Join an exclusive community of ambassadors</li>
            </ul>
          </div>

          <div class="pitch-section">
            <h3 class="pitch-heading">You'll represent Flowmaster:</h3>
            <p class="pitch-text">
              This means upholding our brand values. You are the face of
              Flowmaster to everyone you invite.
            </p>
          </div>
        </div>

        <!-- Email Form -->
        <div class="email-form-box">
          <h3 class="form-label">Enter your email to get started</h3>
          <input
            type="email"
            id="email-input"
            class="email-input"
            placeholder="your@email.com"
            required
          />

          <label class="checkbox-row">
            <input type="checkbox" id="conduct-checkbox" />
            <span class="checkbox-text">
              I understand I'm representing Flowmaster and agree to the
              <button type="button" class="guidelines-link" id="open-guidelines">Scout Conduct Guidelines</button>
            </span>
          </label>

          <button id="continue-btn" class="btn-continue" disabled>
            Continue with Email
          </button>

          <p id="form-error" class="form-error" style="display: none;"></p>
          <p id="form-sending" class="form-sending" style="display: none;">Sending magic link...</p>
        </div>
      </div>

      <!-- Error State -->
      <div id="error-state" class="state-container" style="display: none;">
        <div class="error-emoji">ðŸ˜•</div>
        <h1 class="headline">This invite isn't valid</h1>
        <p class="error-message" id="error-message"></p>
        <a href="https://www.flowmaster.live" class="btn-primary-link">Visit Flowmaster</a>
      </div>
    </div>
  </div>

  <ScoutConductModal />
</BaseLayout>

<style>
  .scout-page {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
    position: relative;
    z-index: 1;
  }

  .scout-container {
    max-width: 620px;
    width: 100%;
    text-align: center;
  }

  .logo-container {
    margin-bottom: 2.5rem;
    animation: fade-in-up 0.6s ease-out;
  }

  .logo-link { text-decoration: none; }

  .logo-text {
    font-family: var(--font-heading);
    font-size: 2rem;
    font-weight: 700;
    color: #f2f2f2;
  }

  .state-container {
    animation: fade-in-up 0.6s ease-out 0.2s backwards;
  }

  /* Loading */
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-bg-tertiary);
    border-top-color: #facf64;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    color: var(--color-gray-400);
    font-size: 1rem;
  }

  /* Badge */
  .selected-badge {
    display: inline-block;
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 0.85rem;
    letter-spacing: 0.15em;
    color: #facf64;
    margin-bottom: 1rem;
  }

  .headline {
    font-size: 2.25rem;
    margin-bottom: 1.5rem;
    color: #f2f2f2;
  }

  @media (min-width: 768px) {
    .headline { font-size: 2.75rem; }
  }

  /* Pitch Box */
  .pitch-box {
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-bg-tertiary);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    text-align: left;
  }

  .pitch-intro {
    color: var(--color-gray-300);
    line-height: 1.6;
    margin-bottom: 1.25rem;
  }

  .pitch-section {
    margin-bottom: 1rem;
  }

  .pitch-section:last-child {
    margin-bottom: 0;
  }

  .pitch-heading {
    font-size: 1rem;
    font-weight: 700;
    color: #f2f2f2;
    margin-bottom: 0.5rem;
  }

  .pitch-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .pitch-list li {
    position: relative;
    padding-left: 1.25rem;
    color: var(--color-gray-300);
    line-height: 1.8;
    font-size: 0.9rem;
  }

  .pitch-list li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.7em;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #facf64;
  }

  .pitch-text {
    color: var(--color-gray-300);
    line-height: 1.6;
    font-size: 0.9rem;
  }

  /* Email Form */
  .email-form-box {
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-bg-tertiary);
    border-radius: 0.75rem;
    padding: 1.5rem;
    text-align: left;
  }

  .form-label {
    font-size: 1rem;
    color: #f2f2f2;
    margin-bottom: 0.75rem;
  }

  .email-input {
    width: 100%;
    padding: 0.75rem 1rem;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-gray-700);
    border-radius: 0.5rem;
    color: #f2f2f2;
    font-size: 1rem;
    font-family: var(--font-body);
    outline: none;
    transition: border-color 0.2s;
    margin-bottom: 1rem;
    box-sizing: border-box;
  }

  .email-input:focus {
    border-color: #facf64;
  }

  .email-input::placeholder {
    color: var(--color-gray-500);
  }

  .checkbox-row {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
    cursor: pointer;
  }

  .checkbox-row input[type="checkbox"] {
    margin-top: 0.2rem;
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    accent-color: #facf64;
    cursor: pointer;
  }

  .checkbox-text {
    font-size: 0.85rem;
    color: var(--color-gray-300);
    line-height: 1.5;
  }

  .guidelines-link {
    background: none;
    border: none;
    color: #facf64;
    cursor: pointer;
    font-size: 0.85rem;
    text-decoration: underline;
    padding: 0;
    font-family: inherit;
  }

  .guidelines-link:hover {
    color: #ffe08a;
  }

  .btn-continue {
    display: block;
    width: 100%;
    padding: 0.85rem;
    background: #facf64;
    color: #101010;
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 1rem;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-continue:hover:not(:disabled) {
    background: #ffe08a;
    box-shadow: 0 10px 20px -5px rgba(250, 207, 100, 0.2);
  }

  .btn-continue:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .form-error {
    margin-top: 0.75rem;
    color: var(--color-brand-red);
    font-size: 0.85rem;
  }

  .form-sending {
    margin-top: 0.75rem;
    color: #facf64;
    font-size: 0.85rem;
  }

  /* Error State */
  .error-emoji {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .error-message {
    font-size: 1.125rem;
    color: var(--color-gray-300);
    margin-bottom: 2rem;
    line-height: 1.6;
  }

  .btn-primary-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color-brand-red);
    color: #f2f2f2;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    text-decoration: none;
    transition: all 0.2s;
  }

  .btn-primary-link:hover {
    background-color: var(--color-brand-red-bright);
  }

  @keyframes fade-in-up {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<script>
  const SUPABASE_URL = 'https://zkmfjmzoqjcylvhxbwii.supabase.co';

  const errorMessages: Record<string, string> = {
    not_found: "This Scout invite link is invalid or has expired. Scout invitations are by personal invitation only.",
    already_claimed: "This Scout invite has already been used. If you're having trouble accessing your account, contact us.",
    expired: "This Scout invite has expired. Please reach out to request a new invitation.",
    default: "We couldn't validate your invite. Please check the link and try again."
  };

  function getInviteCode(): string | null {
    const params = new URLSearchParams(window.location.search);
    return params.get('code');
  }

  async function validateScoutInvite(code: string) {
    const response = await fetch(`${SUPABASE_URL}/functions/v1/validate-scout-invite`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });
    return response.json();
  }

  async function initiateSignup(code: string, email: string) {
    const response = await fetch(`${SUPABASE_URL}/functions/v1/initiate-scout-signup`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, email })
    });
    return response.json();
  }

  function showError(errorType: string) {
    document.getElementById('loading-state')!.style.display = 'none';
    document.getElementById('main-state')!.style.display = 'none';
    const errorState = document.getElementById('error-state')!;
    document.getElementById('error-message')!.textContent =
      errorMessages[errorType] || errorMessages.default;
    errorState.style.display = 'block';
  }

  function showMain() {
    document.getElementById('loading-state')!.style.display = 'none';
    document.getElementById('error-state')!.style.display = 'none';
    document.getElementById('main-state')!.style.display = 'block';
  }

  async function init() {
    const code = getInviteCode();
    if (!code) {
      showError('not_found');
      return;
    }

    try {
      const data = await validateScoutInvite(code);
      if (!data.valid) {
        showError(data.reason || 'default');
      } else {
        // Store invite code for use on the complete page
        sessionStorage.setItem('scout_invite_code', code);
        showMain();
        setupForm(code);
      }
    } catch (err) {
      console.error('Validation error:', err);
      showError('default');
    }
  }

  function setupForm(code: string) {
    const emailInput = document.getElementById('email-input') as HTMLInputElement;
    const checkbox = document.getElementById('conduct-checkbox') as HTMLInputElement;
    const continueBtn = document.getElementById('continue-btn') as HTMLButtonElement;
    const formError = document.getElementById('form-error')!;
    const formSending = document.getElementById('form-sending')!;
    const guidelinesBtn = document.getElementById('open-guidelines')!;

    function updateButtonState() {
      const emailValid = emailInput.value.includes('@') && emailInput.value.includes('.');
      continueBtn.disabled = !(emailValid && checkbox.checked);
    }

    emailInput.addEventListener('input', updateButtonState);
    checkbox.addEventListener('change', updateButtonState);

    guidelinesBtn.addEventListener('click', () => {
      (window as any).openConductModal?.();
    });

    continueBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      if (!email) return;

      formError.style.display = 'none';
      formSending.style.display = 'block';
      continueBtn.disabled = true;

      try {
        const data = await initiateSignup(code, email);
        if (data.success) {
          window.location.href = '/scout/email-sent/';
        } else {
          formError.textContent = data.message || 'Something went wrong. Please try again.';
          formError.style.display = 'block';
          formSending.style.display = 'none';
          continueBtn.disabled = false;
        }
      } catch (err) {
        formError.textContent = 'Network error. Please check your connection and try again.';
        formError.style.display = 'block';
        formSending.style.display = 'none';
        continueBtn.disabled = false;
      }
    });
  }

  init();
</script>
