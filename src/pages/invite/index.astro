---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ConfettiBackground from '../../components/ConfettiBackground.astro';
---

<BaseLayout
  title="Beta Invite"
  description="Your exclusive beta access to Flowmaster is ready"
  showNav={false}
>
  <ConfettiBackground />

  <div class="invite-page">
    <div class="invite-container">
      <!-- Logo -->
      <div class="logo-container">
        <a href="/" class="logo-link">
          <span class="logo-text">Flowmaster</span>
        </a>
      </div>

      <!-- Loading State -->
      <div id="loading-state" class="state-container">
        <div class="spinner"></div>
        <p class="loading-text">Validating your invite...</p>
      </div>

      <!-- Success State -->
      <div id="success-state" class="state-container" style="display: none;">
        <h1 class="headline" id="greeting">You're Invited!</h1>
        <p class="subheadline">Your exclusive beta access to Flowmaster is ready.</p>

        <div class="description-box">
          <p>
            Flowmaster is the ultimate workflow tool for OBS Studio creators.
            Mark highlights while you record, and let Flowmaster automatically
            extract your best moments. No more scrubbing through hours of footage.
          </p>
        </div>

        <!-- Key Reveal Button -->
        <button id="reveal-btn" class="btn-reveal">
          <span class="btn-icon">üéÅ</span>
          Reveal Your Beta Key
        </button>

        <!-- Key Display (hidden initially) -->
        <div id="key-container" class="key-container" style="display: none;">
          <div class="key-badge">BETA KEY</div>
          <div class="key-display">
            <code id="beta-key" class="key-code"></code>
            <button id="copy-btn" class="copy-btn" aria-label="Copy key to clipboard">
              <svg id="copy-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              <svg id="check-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </button>
          </div>
        </div>

        <!-- Download Button -->
        <a href="https://www.flowmaster.live/download" class="btn-download" id="download-btn" style="display: none;">
          <span class="btn-icon">‚¨á</span>
          Download for Windows
          <span class="btn-subtext">Windows 10/11 ‚Ä¢ Free during beta</span>
        </a>

        <!-- Further Help Section -->
        <div id="help-section" class="help-section" style="display: none;">
          <div class="divider">Further Help</div>

          <div class="help-box">
            <h3 class="help-title">üìñ How to Activate Your Key</h3>
            <ol class="help-list">
              <li>Download and install Flowmaster</li>
              <li>Launch the app</li>
              <li>When prompted, paste your beta key</li>
              <li>You're in! Start recording.</li>
            </ol>
          </div>

          <div class="help-box">
            <h3 class="help-title">üìö Documentation & Guides</h3>
            <ul class="help-links">
              <li><a href="/docs/obs-setup">‚Üí OBS Setup Guide</a></li>
              <li><a href="/docs">‚Üí Full Documentation</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Error State -->
      <div id="error-state" class="state-container" style="display: none;">
        <div class="error-emoji">üòï</div>
        <h1 class="headline">Oops! Something's not right</h1>
        <p class="error-message" id="error-message"></p>
        <a href="https://www.flowmaster.live" class="btn-primary">Visit Flowmaster</a>
      </div>
    </div>
  </div>

  <!-- Toast notification for copy feedback -->
  <div id="toast" class="toast" style="display: none;">
    Key copied!
  </div>
</BaseLayout>

<style>
  .invite-page {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
    position: relative;
    z-index: 1;
  }

  .invite-container {
    max-width: 600px;
    width: 100%;
    text-align: center;
  }

  .logo-container {
    margin-bottom: 3rem;
    animation: fade-in-up 0.6s ease-out;
  }

  .logo-link {
    text-decoration: none;
  }

  .logo-text {
    font-family: var(--font-heading);
    font-size: 2rem;
    font-weight: 700;
    color: #f2f2f2;
  }

  .state-container {
    animation: fade-in-up 0.6s ease-out 0.2s backwards;
  }

  /* Loading State */
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-bg-tertiary);
    border-top-color: var(--color-brand-red);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-text {
    color: var(--color-gray-400);
    font-size: 1rem;
  }

  /* Success State */
  .headline {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    color: #f2f2f2;
  }

  @media (min-width: 768px) {
    .headline {
      font-size: 3rem;
    }
  }

  .subheadline {
    font-size: 1.125rem;
    color: var(--color-gray-300);
    margin-bottom: 2rem;
  }

  .description-box {
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-bg-tertiary);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .description-box p {
    margin: 0;
    line-height: 1.6;
    color: var(--color-gray-300);
  }

  /* Reveal Button */
  .btn-reveal {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background-color: var(--color-brand-red);
    color: #f2f2f2;
    font-family: var(--font-heading);
    font-weight: 600;
    font-size: 1.125rem;
    padding: 1rem 2rem;
    border-radius: 0.75rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 2rem;
  }

  .btn-reveal:hover {
    background-color: var(--color-brand-red-bright);
    box-shadow: 0 10px 20px -5px rgba(244, 63, 67, 0.3);
    transform: translateY(-2px);
  }

  .btn-reveal:active {
    transform: translateY(0);
  }

  .btn-icon {
    font-size: 1.25rem;
  }

  /* Key Container */
  .key-container {
    background-color: var(--color-bg-secondary);
    border: 2px solid var(--color-brand-red);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    animation: slide-in 0.4s ease-out;
  }

  @keyframes slide-in {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .key-badge {
    display: inline-block;
    background-color: var(--color-step-autoclean);
    color: #101010;
    font-family: var(--font-heading);
    font-weight: 700;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.25rem 0.75rem;
    border-radius: 0.25rem;
    margin-bottom: 1rem;
  }

  .key-display {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background-color: var(--color-bg-tertiary);
    padding: 1rem;
    border-radius: 0.5rem;
  }

  .key-code {
    flex: 1;
    font-family: 'Courier New', monospace;
    font-size: 1rem;
    color: #f2f2f2;
    letter-spacing: 0.05em;
    word-break: break-all;
  }

  @media (min-width: 640px) {
    .key-code {
      font-size: 1.125rem;
    }
  }

  .copy-btn {
    flex-shrink: 0;
    background-color: var(--color-brand-red);
    color: #f2f2f2;
    border: none;
    border-radius: 0.375rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .copy-btn:hover {
    background-color: var(--color-brand-red-bright);
  }

  /* Download Button */
  .btn-download {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    background-color: var(--color-brand-red);
    color: #f2f2f2;
    font-family: var(--font-heading);
    font-weight: 600;
    font-size: 1.125rem;
    padding: 1rem 2rem;
    border-radius: 0.75rem;
    text-decoration: none;
    transition: all 0.2s;
    margin-bottom: 2rem;
  }

  .btn-download:hover {
    background-color: var(--color-brand-red-bright);
    box-shadow: 0 10px 20px -5px rgba(244, 63, 67, 0.3);
    transform: translateY(-2px);
  }

  .btn-subtext {
    font-family: var(--font-body);
    font-size: 0.75rem;
    font-weight: 400;
    color: rgba(255, 255, 255, 0.7);
  }

  /* Help Section */
  .help-section {
    margin-top: 3rem;
  }

  .divider {
    position: relative;
    text-align: center;
    color: var(--color-gray-500);
    font-size: 0.875rem;
    margin-bottom: 2rem;
  }

  .divider::before,
  .divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 40%;
    height: 1px;
    background-color: var(--color-gray-700);
  }

  .divider::before {
    left: 0;
  }

  .divider::after {
    right: 0;
  }

  .help-box {
    text-align: left;
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-bg-tertiary);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
  }

  .help-title {
    font-size: 1.125rem;
    margin-bottom: 1rem;
    color: #f2f2f2;
  }

  .help-list {
    margin: 0;
    padding-left: 1.5rem;
    color: var(--color-gray-300);
    line-height: 1.8;
  }

  .help-list li {
    margin-bottom: 0.5rem;
  }

  .help-links {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .help-links li {
    margin-bottom: 0.5rem;
  }

  .help-links a {
    color: var(--color-brand-red);
    text-decoration: none;
    transition: color 0.2s;
  }

  .help-links a:hover {
    color: var(--color-brand-red-bright);
  }

  /* Error State */
  .error-emoji {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .error-message {
    font-size: 1.125rem;
    color: var(--color-gray-300);
    margin-bottom: 2rem;
    line-height: 1.6;
  }

  .btn-primary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color-brand-red);
    color: #f2f2f2;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    text-decoration: none;
    transition: all 0.2s;
  }

  .btn-primary:hover {
    background-color: var(--color-brand-red-bright);
    box-shadow: 0 10px 15px -3px rgba(244, 63, 67, 0.2);
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--color-step-autoclean);
    color: #101010;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.5);
    z-index: 1000;
    animation: toast-in 0.3s ease-out;
  }

  @keyframes toast-in {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  @keyframes fade-in-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  // Get invite code from URL
  function getInviteCode(): string | null {
    const path = window.location.pathname;
    const params = new URLSearchParams(window.location.search);

    // Support both /invite/CODE and /invite?code=CODE
    let code = params.get('code');
    if (!code && path.startsWith('/invite/')) {
      code = path.replace('/invite/', '').replace('/', '');
    }

    return code;
  }

  // Error messages based on error type
  const errorMessages: Record<string, string> = {
    not_found: "This invite link doesn't exist. It may have been typed incorrectly, or you might need to request a new one.",
    inactive: "This invite link has been deactivated. Please reach out to whoever shared it with you for a fresh link.",
    already_claimed: "This beta key has already been activated on another device. Each key can only be used once.",
    default: "We couldn't validate your invite. Please check the link and try again."
  };

  // Validate invite code with edge function
  async function validateInvite(code: string) {
    const response = await fetch('https://zkmfjmzoqjcylvhxbwii.supabase.co/functions/v1/validate-invite-link', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ code })
    });

    if (!response.ok) {
      throw new Error('Network error');
    }

    return response.json();
  }

  // Show toast notification
  function showToast(message: string) {
    const toast = document.getElementById('toast');
    if (toast) {
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 2000);
    }
  }

  // Show error state
  function showError(errorType: string) {
    document.getElementById('loading-state')!.style.display = 'none';
    document.getElementById('success-state')!.style.display = 'none';
    const errorState = document.getElementById('error-state')!;
    const errorMessage = document.getElementById('error-message')!;

    errorMessage.textContent = errorMessages[errorType] || errorMessages.default;
    errorState.style.display = 'block';
  }

  // Show success state
  function showSuccess(data: any) {
    document.getElementById('loading-state')!.style.display = 'none';
    document.getElementById('error-state')!.style.display = 'none';
    const successState = document.getElementById('success-state')!;

    // Personalized greeting
    const greeting = document.getElementById('greeting')!;
    if (data.invite?.recipient_name) {
      greeting.textContent = `Hey ${data.invite.recipient_name}! üëã`;
    }

    // Store beta key for reveal
    const revealBtn = document.getElementById('reveal-btn') as HTMLButtonElement;
    const keyContainer = document.getElementById('key-container')!;
    const betaKeyEl = document.getElementById('beta-key')!;
    const downloadBtn = document.getElementById('download-btn')!;
    const helpSection = document.getElementById('help-section')!;

    betaKeyEl.textContent = data.invite.license_key;

    // Reveal button handler
    revealBtn.addEventListener('click', () => {
      revealBtn.style.display = 'none';
      keyContainer.style.display = 'block';
      downloadBtn.style.display = 'inline-flex';
      helpSection.style.display = 'block';
    });

    // Copy button handler
    const copyBtn = document.getElementById('copy-btn')!;
    const copyIcon = document.getElementById('copy-icon')!;
    const checkIcon = document.getElementById('check-icon')!;

    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(data.invite.license_key);
        copyIcon.style.display = 'none';
        checkIcon.style.display = 'block';
        showToast('Key copied!');

        setTimeout(() => {
          copyIcon.style.display = 'block';
          checkIcon.style.display = 'none';
        }, 2000);
      } catch (err) {
        showToast('Failed to copy');
      }
    });

    successState.style.display = 'block';
  }

  // Main initialization
  async function init() {
    const code = getInviteCode();

    if (!code) {
      showError('not_found');
      return;
    }

    try {
      const data = await validateInvite(code);

      if (!data.valid) {
        showError(data.reason || 'default');
      } else {
        showSuccess(data);
      }
    } catch (error) {
      console.error('Validation error:', error);
      showError('default');
    }
  }

  // Run on page load
  init();
</script>
