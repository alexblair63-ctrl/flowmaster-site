---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Purchase Complete" description="Your Flowmaster license key is ready.">
  <!-- Loading State -->
  <section id="state-loading" class="section-padding min-h-[60vh] flex items-center justify-center">
    <div class="text-center">
      <div class="loading-spinner mx-auto mb-6"></div>
      <p class="text-lg text-gray-300">Verifying your purchase...</p>
    </div>
  </section>

  <!-- Success State (hidden by default) -->
  <section id="state-success" class="section-padding hidden">
    <canvas id="confetti-canvas"></canvas>
    <div class="container-main max-w-2xl mx-auto text-center">
      <!-- Tier heading -->
      <h1 id="tier-heading" class="mb-2 animate-fade-in-up"></h1>
      <p id="tier-subtext" class="text-lg text-gray-400 mb-10 animate-fade-in-up"></p>

      <!-- Key Card -->
      <div class="key-card animate-fade-in-up">
        <p class="text-sm text-gray-400 mb-3 uppercase tracking-wider">Your License Key</p>
        <p id="license-key" class="key-display"></p>
        <button id="copy-btn" class="copy-btn mt-4" type="button">
          <svg class="copy-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="5" y="5" width="9" height="9" rx="1.5" stroke="currentColor" stroke-width="1.5"/>
            <path d="M3 11V3C3 2.44772 3.44772 2 4 2H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <span id="copy-text">Copy Key</span>
        </button>
      </div>

      <!-- Email confirmation -->
      <p id="email-line" class="text-gray-400 mt-6 animate-fade-in-up"></p>

      <!-- Next Steps -->
      <div class="mt-14 animate-fade-in-up">
        <h2 class="text-xl mb-6">What's Next</h2>
        <div class="next-steps-grid">
          <a href="/download" class="next-step-card">
            <div class="next-step-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            </div>
            <h3 class="text-base font-semibold mt-3">Download Flowmaster</h3>
            <p class="text-sm text-gray-400 mt-1">Get the desktop app</p>
          </a>
          <a href="https://discord.gg/VmugsGgN66" target="_blank" rel="noopener noreferrer" class="next-step-card">
            <div class="next-step-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
            </div>
            <h3 class="text-base font-semibold mt-3">Join the Community</h3>
            <p class="text-sm text-gray-400 mt-1">Connect with creators</p>
          </a>
          <a href="/docs" class="next-step-card">
            <div class="next-step-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
            </div>
            <h3 class="text-base font-semibold mt-3">Quick Start Guide</h3>
            <p class="text-sm text-gray-400 mt-1">Learn the basics</p>
          </a>
        </div>
      </div>

      <!-- Social share placeholder -->
      <div class="mt-12 animate-fade-in-up">
        <p class="text-sm text-gray-500 mb-3">Share your support:</p>
        <div class="flex justify-center gap-3">
          <!-- TODO: Enhanced social sharing in future -->
          <a id="tweet-btn" href="#" target="_blank" rel="noopener noreferrer" class="btn-secondary text-sm px-4 py-2">
            <svg class="inline-block mr-1.5 -mt-0.5" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            Tweet
          </a>
          <button id="share-link-btn" type="button" class="btn-secondary text-sm px-4 py-2">
            <svg class="inline-block mr-1.5 -mt-0.5" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
            <span id="share-link-text">Copy Link</span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Error State (hidden by default) -->
  <section id="state-error" class="section-padding min-h-[60vh] flex items-center justify-center hidden">
    <div class="text-center max-w-md mx-auto px-6">
      <div class="error-icon mx-auto mb-6">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--color-brand-red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      </div>
      <h2 id="error-heading" class="mb-3"></h2>
      <p id="error-message" class="text-gray-400 mb-8"></p>
      <div id="error-actions" class="flex flex-col sm:flex-row gap-3 justify-center"></div>
    </div>
  </section>
</BaseLayout>

<style>
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-bg-tertiary);
    border-top-color: var(--color-brand-red);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  #confetti-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 50;
  }

  .key-card {
    background: var(--color-bg-secondary);
    border: 2px solid var(--color-brand-red);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 0 20px rgba(244, 63, 67, 0.4);
    max-width: 600px;
    margin: 0 auto;
  }

  .key-display {
    font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
    font-size: 1.5rem;
    color: #f2f2f2;
    letter-spacing: 0.05em;
    word-break: break-all;
    user-select: all;
  }

  @media (max-width: 768px) {
    .key-display {
      font-size: 1.2rem;
    }
    .key-card {
      padding: 1.5rem 1rem;
    }
  }

  .copy-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: var(--color-bg-tertiary);
    color: var(--color-gray-300);
    border: 1px solid var(--color-gray-700);
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .copy-btn:hover {
    background: var(--color-gray-700);
    color: #f2f2f2;
  }

  .copy-btn.copied {
    background: rgba(107, 229, 83, 0.15);
    border-color: #6be553;
    color: #6be553;
  }

  .next-steps-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }

  @media (max-width: 768px) {
    .next-steps-grid {
      grid-template-columns: 1fr;
    }
  }

  .next-step-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-bg-tertiary);
    border-radius: 0.75rem;
    padding: 1.5rem;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s;
    display: block;
  }

  .next-step-card:hover {
    border-color: var(--color-gray-700);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .next-step-icon {
    color: var(--color-brand-red);
  }

  .error-icon {
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(244, 63, 67, 0.1);
    border-radius: 50%;
  }
</style>

<script>
  const SUPABASE_URL = 'https://jwwbwozjvfiheunavbnk.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3d2J3b3pqdmZpaGV1bmF2Ym5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MDA1ODAsImV4cCI6MjA4MjM3NjU4MH0.hJau-XnPeTLJ2Q6f-VMNHF4YS92EBDR7FmSKVa3cX10';

  const TIER_MESSAGES: Record<string, { heading: (seq: number) => string; subtext: string }> = {
    pioneer: {
      heading: (seq) => `You're Early Adopter #${seq} of 15!`,
      subtext: "You're one of the first.",
    },
    early_adopter: {
      heading: (seq) => `You're Supporter #${seq}!`,
      subtext: 'Thanks for believing early.',
    },
    believer: {
      heading: (seq) => `You're Semi-Early #${seq}!`,
      subtext: 'Welcome aboard.',
    },
    standard: {
      heading: () => 'Welcome to Flowmaster!',
      subtext: "You've got the full experience.",
    },
  };

  const ERROR_CONFIG: Record<string, { heading: string; message: string; actions: Array<{ label: string; href?: string; retry?: boolean; style: string }> }> = {
    no_session_id: {
      heading: 'Missing Session Info',
      message: "If you just purchased, check your email — your key was sent there.",
      actions: [
        { label: 'Check Email', href: 'mailto:', style: 'primary' },
        { label: 'Go Home', href: '/', style: 'secondary' },
      ],
    },
    invalid_session: {
      heading: 'Purchase Not Found',
      message: "We couldn't find this purchase. If you completed payment, check your email.",
      actions: [
        { label: 'Check Email', href: 'mailto:', style: 'primary' },
        { label: 'Go Home', href: '/', style: 'secondary' },
      ],
    },
    payment_incomplete: {
      heading: 'Payment Incomplete',
      message: "Your payment wasn't completed.",
      actions: [
        { label: 'Return to Pricing', href: '/pricing', style: 'primary' },
      ],
    },
    network_error: {
      heading: 'Connection Error',
      message: "We couldn't connect to verify your purchase.",
      actions: [
        { label: 'Try Again', retry: true, style: 'primary' },
        { label: 'Check Email', href: 'mailto:', style: 'secondary' },
      ],
    },
    server_error: {
      heading: 'Something Went Wrong',
      message: 'Please try again or contact support.',
      actions: [
        { label: 'Try Again', retry: true, style: 'primary' },
        { label: 'Contact Support', href: 'mailto:support@flowmaster.live', style: 'secondary' },
      ],
    },
  };

  const DEMO_DATA = {
    success: true,
    key: 'FM-DEMO1-ABCDE-FGHIJ-KLMNO',
    email: 'demo@example.com',
    tierName: 'Early Adopter',
    tierSequence: 3,
    tierInternalName: 'pioneer',
    price: 12,
    purchasedAt: new Date().toISOString(),
  };

  // DOM refs
  const stateLoading = document.getElementById('state-loading')!;
  const stateSuccess = document.getElementById('state-success')!;
  const stateError = document.getElementById('state-error')!;

  function showState(state: 'loading' | 'success' | 'error') {
    stateLoading.classList.toggle('hidden', state !== 'loading');
    stateSuccess.classList.toggle('hidden', state !== 'success');
    stateError.classList.toggle('hidden', state !== 'error');
  }

  function showError(code: string) {
    const config = ERROR_CONFIG[code] || ERROR_CONFIG.server_error;
    document.getElementById('error-heading')!.textContent = config.heading;
    document.getElementById('error-message')!.textContent = config.message;

    const actionsEl = document.getElementById('error-actions')!;
    actionsEl.innerHTML = '';
    config.actions.forEach((action) => {
      if (action.retry) {
        const btn = document.createElement('button');
        btn.textContent = action.label;
        btn.className = action.style === 'primary' ? 'btn-primary' : 'btn-secondary';
        btn.addEventListener('click', () => init());
        actionsEl.appendChild(btn);
      } else {
        const a = document.createElement('a');
        a.textContent = action.label;
        a.href = action.href || '/';
        a.className = action.style === 'primary' ? 'btn-primary' : 'btn-secondary';
        actionsEl.appendChild(a);
      }
    });

    showState('error');
  }

  function showSuccess(data: typeof DEMO_DATA) {
    const tier = TIER_MESSAGES[data.tierInternalName] || TIER_MESSAGES.standard;
    document.getElementById('tier-heading')!.textContent = tier.heading(data.tierSequence);
    document.getElementById('tier-subtext')!.textContent = tier.subtext;
    document.getElementById('license-key')!.textContent = data.key;
    document.getElementById('email-line')!.innerHTML =
      `&#10003; We've sent your key to <strong>${data.email}</strong>`;

    // Tweet intent
    const tweetBtn = document.getElementById('tweet-btn') as HTMLAnchorElement;
    tweetBtn.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent('I just got Flowmaster! \uD83C\uDFAC')}&url=${encodeURIComponent('https://flowmaster.live')}`;

    // Copy link button
    const shareLinkBtn = document.getElementById('share-link-btn')!;
    const shareLinkText = document.getElementById('share-link-text')!;
    shareLinkBtn.addEventListener('click', async () => {
      await navigator.clipboard.writeText('https://flowmaster.live');
      shareLinkText.textContent = 'Copied!';
      setTimeout(() => { shareLinkText.textContent = 'Copy Link'; }, 2000);
    });

    showState('success');

    // Fire confetti once per session
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('session_id') || 'demo';
    const visitedKey = `visited_${sessionId}`;

    if (!sessionStorage.getItem(visitedKey)) {
      triggerConfetti();
      sessionStorage.setItem(visitedKey, 'true');
    }

    // Analytics
    (window as any).plausible?.('Purchase', {
      props: {
        tier: data.tierInternalName,
        price: data.price,
        tierDisplay: data.tierName,
      },
    });
  }

  // Copy key button
  document.getElementById('copy-btn')!.addEventListener('click', async () => {
    const key = document.getElementById('license-key')!.textContent || '';
    await navigator.clipboard.writeText(key);
    const copyText = document.getElementById('copy-text')!;
    const copyBtn = document.getElementById('copy-btn')!;
    copyText.textContent = '\u2713 Copied!';
    copyBtn.classList.add('copied');
    setTimeout(() => {
      copyText.textContent = 'Copy Key';
      copyBtn.classList.remove('copied');
    }, 2000);
  });

  // Confetti — canvas-based particle system
  function triggerConfetti() {
    const canvas = document.getElementById('confetti-canvas') as HTMLCanvasElement;
    const ctx = canvas.getContext('2d')!;
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const isMobile = window.innerWidth <= 768;
    const PARTICLE_COUNT = isMobile ? 80 : 150;
    const COLORS = ['#f43f43', '#55ffa2', '#ffffff', '#f5d440'];
    const GRAVITY = 0.12;
    const DURATION = 4000;

    interface Particle {
      x: number;
      y: number;
      vx: number;
      vy: number;
      color: string;
      size: number;
      rotation: number;
      rotSpeed: number;
      shape: 'rect' | 'circle';
    }

    const particles: Particle[] = [];
    for (let i = 0; i < PARTICLE_COUNT; i++) {
      particles.push({
        x: canvas.width / 2 + (Math.random() - 0.5) * 200,
        y: canvas.height * 0.3,
        vx: (Math.random() - 0.5) * 12,
        vy: Math.random() * -14 - 4,
        color: COLORS[Math.floor(Math.random() * COLORS.length)],
        size: Math.random() * 6 + 4,
        rotation: Math.random() * Math.PI * 2,
        rotSpeed: (Math.random() - 0.5) * 0.2,
        shape: Math.random() > 0.5 ? 'rect' : 'circle',
      });
    }

    const start = performance.now();

    function animate(now: number) {
      const elapsed = now - start;
      if (elapsed > DURATION) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
      }

      const fade = elapsed > DURATION - 1000 ? (DURATION - elapsed) / 1000 : 1;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.globalAlpha = fade;

      for (const p of particles) {
        p.vy += GRAVITY;
        p.x += p.vx;
        p.y += p.vy;
        p.vx *= 0.99;
        p.rotation += p.rotSpeed;

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rotation);
        ctx.fillStyle = p.color;

        if (p.shape === 'rect') {
          ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
        } else {
          ctx.beginPath();
          ctx.arc(0, 0, p.size / 2, 0, Math.PI * 2);
          ctx.fill();
        }

        ctx.restore();
      }

      ctx.globalAlpha = 1;
      requestAnimationFrame(animate);
    }

    requestAnimationFrame(animate);
  }

  // Fetch purchase data
  async function verifyPurchase(sessionId: string) {
    try {
      const response = await fetch(
        `${SUPABASE_URL}/functions/v1/get-purchase-key`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({ sessionId }),
        }
      );

      if (!response.ok) {
        const data = await response.json().catch(() => ({}));
        return { success: false, error: data.error || 'server_error', message: data.message };
      }

      return await response.json();
    } catch (_error) {
      return { success: false, error: 'network_error', message: 'Network error' };
    }
  }

  // Main init
  async function init() {
    showState('loading');

    const params = new URLSearchParams(window.location.search);
    const isDemo = params.get('demo') === 'true';
    const sessionId = params.get('session_id');

    if (isDemo) {
      // Short delay to show loading state in demo
      await new Promise((r) => setTimeout(r, 800));
      showSuccess(DEMO_DATA);
      return;
    }

    if (!sessionId) {
      showError('no_session_id');
      return;
    }

    const result = await verifyPurchase(sessionId);

    if (result.success) {
      showSuccess(result);
    } else {
      showError(result.error || 'server_error');
    }
  }

  init();
</script>
